<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/google-youtube/google-youtube.html">
<link rel="import" href="swiftui-karatext.html">

<polymer-element name="swiftui-kara" attributes="flyDuration audioSrcType audioSrc">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
				overflow: hidden;
				text-align: center;
			}
		</style>
		<template if="{{audioSrcType=='youtube'}}">
			<google-youtube id="youtube" videoid="{{audioSrc}}" height="0px" width="0px" chromeless="true"></google-youtube>
		</template>
		<template if="{{audioSrcType=='audio'}}">
			<audio id="audio" src="{[audioSrc}}" preload="auto"></audio>
		</template>
		<content></content>
	</template>

	<script>
		(function() {
			var KARA_FULL_READY = 2;

			var STATE_KARA_NOT_READY = -1;
			var STATE_KARA_READY = 0;
			var STATE_KARA_PLAYING = 1;
			var STATE_KARA_PAUSED = 2;
			var STATE_KARA_ENDED = 3;

			/* User action and state:
			/* User action (play, pause) -> kara's public function -> youtube's state changed ->
			/* kara's state changed -> kara's private function -> kara fires event -> user agent listens event */

			Polymer({
				state: STATE_KARA_NOT_READY,

				_karaReadyLevel: 0,

				/* Registering and event functions */
				/* ====================== */

				_karaReadyLevelChanged: function() {
					if (this._karaReadyLevel == KARA_FULL_READY)
						this.state = STATE_KARA_READY;
				},

				stateChanged: function() {
					if (this.state == STATE_KARA_READY) {
						this.fire("kara-ready");
					} else if (this.state == STATE_KARA_PAUSED) {
						window.clearInterval(this._timer);
						this._pauseJobs();
						this.fire("kara-paused");
					} else if (this.state == STATE_KARA_ENDED) {
						window.clearInterval(this._timer);
						this._endJobs();
						this.fire("kara-ended");
					} else if (this.state == STATE_KARA_PLAYING) {
						this._playTimer();
						this.fire("kara-playing");
					}
				},

				registerKaratext: function(childKaratext) {
					this._childrenKaratext.push(childKaratext);
					if (this._childrenKaratext.length == this._numberOfKaratext) {
						/* Set parent to center center flex layout */
						this.parentNode.setAttribute("horizontal", "");
						this.parentNode.setAttribute("layout", "");
						this.parentNode.setAttribute("center", "");
						this.parentNode.setAttribute("center-justified", "");

						this.async(function() {
							this._karaReadyLevel++;
						});
					}
				},

				/* ====================== */



				/* Properties functions */
				/* ====================== */

				/* seconds */
				getCurrentPlayTime: function() {
					return this._player.getCurrentPlayTime();
				},

				/* seconds */
				getDuration: function() {
					return this._player.getDuration();
				},

				/* HH:MM:SS */
				getFormattedCurrentPlayTime: function() {
					return this._player.getFormattedCurrentPlayTime();
				},

				/* HH:MM:SS */
				getFormattedDuration: function() {
					return this._player.getFormattedDuration();
				},

				/* ====================== */



				/* Player object */
				/* ====================== */

				_getPlayer: function() {
					var Player;
					var thisEl = this;

					switch (this.audioSrcType) {
						case "youtube":
							Player = function() {
								var youtube = this.audioElmt = thisEl.$.youtube;

								this.playerType = "youtube";

								this.play = function() {
									youtube.play();
								};

								this.pause = function() {
									youtube.pause();
								};

								this.seekTo = function(s) {
									youtube.seekTo(s);
								};

								this.getCurrentPlayTime = function() {
									return youtube.currenttime;
								};

								this.getDuration = function() {
									return youtube.duration;
								};

								this.getFormattedCurrentPlayTime = function() {
									return youtube.currenttimeformatted;
								};

								this.getFormattedDuration = function() {
									return youtube.durationformatted;
								};

								this.getState = function() {
									return youtube.state;
								};
							};

							break;
						case "audio":
							Player = function() {
								var audio = this.audioElmt = thisEl.$.audio;

								this.playerType = "audio";

								this.play = function() {
									audio.play();
								};

								this.pause = function() {
									audio.pause();
								};

								this.seekTo = function(s) {
									audio.seekTo(s);
								};

								this.getCurrentPlayTime = function() {
									return audio.currenttime;
								};

								this.getDuration = function() {
									return audio.duration;
								};

								this.getFormattedCurrentPlayTime = function() {
									return audio.currenttimeformatted;
								};

								this.getFormattedDuration = function() {
									return audio.durationformatted;
								};

								this.getState = function() {
									return audio.state;
								};
							};
							break;
					}

					return new Player();
				},


				/* Controlling functions */
				/* ====================== */

				pause: function() {
					this._player.pause();
				},

				play: function() {				
					this._player.seekTo(this._currentTime / 1000);
					this._player.play();
				},

				_endJobs: function() {
					for (var i = 0; i < this._childrenKaratext.length; i++)
						this._childrenKaratext[i].reset();

					this._currentTime = 0;
					this._currentKaratextId = 0;
				},

				_pauseJobs: function() {
					var currentId = this._currentKaratextId;
					var currentTime = this._currentTime;

					/* Cancel children timers */
					if (this._currentKaratextId >= 1)
						this._childrenKaratext[currentId - 1].stop();
					if (this._currentKaratextId >= 2)
						this._childrenKaratext[currentId - 2].stop();

					/* Find the suitable back-target karatext */
					currentId -= 2;

					this._currentTime = currentId > 0 ? this._childrenKaratext[currentId - 1].startTime : 0;
					this._currentKaratextId = currentId >= 0 ? currentId : 0;
				},

				_playTimer: function() {
					this._timer = window.setInterval(function() {
						if (this._currentKaratextId < this._childrenKaratext.length) {
							var currentKaratext = this._childrenKaratext[this._currentKaratextId];
							var prevKaratextStartTime = (this._currentKaratextId == 0) ? 
																					0 : this._childrenKaratext[this._currentKaratextId - 1].startTime;
							var prevKaratextEndTime = (this._currentKaratextId == 0) ? 
																					this.flyDuration : this._childrenKaratext[this._currentKaratextId - 1].endTime;

							if (prevKaratextStartTime - this._currentTime <= 0) { // currentKaratext's flyTo2LineTime - currentTime
								currentKaratext.registerTimes(this._currentTime, prevKaratextEndTime);
								currentKaratext.run(this.flyDuration);
								this._currentKaratextId++;
							}
						}

						this._currentTime += this._timerInterval;
					}.bind(this), 100);
				},

				/* ====================== */



				/* Polymer lifecycle functions */
				/* ====================== */

				publish: {
					flyDuration: 400
				},

				created: function() {
					this._childrenKaratext = [];

					this._currentTime = 0;
					this._timerInterval = 100;
					this._currentKaratextId = 0;
				},

				domReady: function() {
					this._numberOfKaratext = this.querySelectorAll("swiftui-karatext").length;

					this._player = this._getPlayer();

					this.addEventListener("google-youtube-ready", function() {
						this.async(function() {
							this._karaReadyLevel++;
						});
					});

					this.addEventListener("google-youtube-state-change", function() {
						switch (this._player.getState()) {
							case 1:
								this.state = STATE_KARA_PLAYING; break;
							case 2:
								if (Math.abs(this._player.getDuration() - this._player.getCurrentPlayTime()) > 1)
									this.state = STATE_KARA_PAUSED;
								break;
							case 0:
								this.state = STATE_KARA_ENDED;
						}
					});
				}

				/* ====================== */

			});
		})();
	</script>
</polymer-element>